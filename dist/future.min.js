/*! Futurejs 0.2.0 2014-01-05 */
!function(){function a(a){return"undefined"==typeof a}function b(a){return"[object Function]"==Object.prototype.toString.call(a)}function c(a){return"[object Array]"==Object.prototype.toString.call(a)}var d=this,e=function(c,d){if(!a(c)){var e;e=b(c)?c():c,this._pending=!1,d?(this._withError=!0,this._error=e):this._data=e}this._callbacks=[]};e.value=function(a){return new e(a)},e.sync=function(a){return new e(a)},e.error=function(a){return new e(a,!0)},e.prototype._pending=!0,e.prototype._data=null,e.prototype._error=null,e.prototype._withError=!1,e.prototype._callbacks=null,e.prototype.then=function(c,d){if(!b(c))throw new Error("onValue callback must be a function");var f=d;if(null!=f&&!a(f)&&!b(f)&&(d=d||{},f=d.onError,!b(f)))throw new Error("onError callback must be a function");var g=new e;return this._pending?this._callbacks.push({onValue:c,onError:f,errorHandled:!1,f:g}):this._innerComplete({onValue:c,onError:f,errorHandled:!1,f:g}),g},e.prototype.catchError=function(a,b){return this.then(function(){},function(c){if(!b||b(c))return a(c);throw c})},e.prototype.whenComplete=function(a){return this.then(function(b){var c=a();return c instanceof e?c.then(function(){return b}):b},{onError:function(b){var c=a();if(c instanceof e)return c.then(function(){throw b});throw b}})},e.prototype._complete=function(a){if(!this._pending)throw new Error("Future already completed");this._pending=!1,this._data=a,this._dispatchCompletion()},e.prototype._innerComplete=function(b){var c;try{if(this._withError){if(!b.onError)throw this._error;c=b.onError(this._error)}else c=b.onValue(this._data)}catch(d){return b.f._completeError(d),void 0}a(c)&&(c=this._data),c instanceof e?c.then(function(a){b.f._complete(a)}).catchError(function(a){b.f._completeError(a)}):b.f._complete(c)},e.prototype._completeError=function(a){if(!this._pending)throw new Error("Future already completed");this._pending=!1,this._withError=!0,this._error=a,this._dispatchCompletion()},e.prototype._dispatchCompletion=function(){var a=this._callbacks.length;if(this._withError&&0==a)throw this._error;for(var b=0;a>b;b++)this._innerComplete(this._callbacks[b])};var f=function(){this.future=new e};f.prototype.future=null,f.prototype.complete=function(a){this.future._complete(a)},f.prototype.completeError=function(a){this.future._completeError(a)},f.prototype.isCompleted=function(){return!this.future._pending},e.wait=function(a){function b(b){a[b].then(function(a){g--,h[b]=a,0>=g&&d.complete(h)}).catchError(function(a){d.isCompleted()||d.completeError(a)})}if(!c(a))throw new Error("List of futures to wait must be an array, "+a+" given");if(0==a.length)return new e.value([]);for(var d=new f,g=a.length,h=new Array(g),i=0;i<a.length;i++){if(!(a[i]instanceof e))throw new Error(a[i]+" is not a Future");b(i)}return d.future},e.forEach=function(a,b){for(var c=[],d=0;d<a.length;d++){var f=b(a[d]);if(!(f instanceof e))throw new Error("Returned element "+a[d]+" is not a Future");c.push(f)}return this.wait(c)},"undefined"!=typeof exports?(module.exports.Future=e,module.exports.Completer=f):(d.Future=e,d.Completer=f)}();